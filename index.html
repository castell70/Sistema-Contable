<html>
<head>
<meta charset="UTF-8">
<title>Sistema Contable by ITCPO</title>

<!-- Import map for potential ESM modules (kept local modules) -->
<script type="importmap">
{
  "imports": {
    "app_security/": "./modules/"
  }
}
</script>

<style>
  :root {
    --primary: #2c3e50;
    --secondary: #34495e;
    --accent: #3498db;
    --light: #ecf0f1;
    --success: #2ecc71;
    --warning: #f1c40f;
    --danger: #e74c3c;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    background-color: var(--light);
    padding: 20px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  .tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--primary);
  }

  .tab {
    padding: 10px 20px;
    cursor: pointer;
    background: var(--primary);
    color: white;
    border: none;
    margin-right: 5px;
    border-radius: 5px 5px 0 0;
    transition: all 0.3s ease;
  }

  .tab.active {
    background: var(--accent);
  }

  .content {
    display: none;
  }

  .content.active {
    display: block;
  }

  .form-group {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  input, select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
  }

  .form-row-double {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: var(--accent);
  }

  .btn-success {
    background: var(--success);
  }

  .btn-warning {
    background: var(--warning);
  }

  .btn-danger {
    background: var(--danger);
  }

  .btn-brown {
    background: #5D4037;
  }

  .btn-orange {
    background: #F57C00;
  }

  .btn-black {
    background: #212121;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border: 1px solid #ddd;
  }

  th {
    background: var(--primary);
    color: white;
  }

  .transactions-list {
    margin-top: 20px;
    max-height: 300px;
    overflow-y: auto;
  }

  .transactions-list table {
    font-size: 0.9em; 
  }

  .transactions-list td, .transactions-list th {
    padding: 8px; 
  }

  .transactions-list .btn {
    font-size: 0.8em;
    padding: 4px 8px;
    margin: 2px;
  }

  #ledger table {
    font-size: 0.9em;
  }

  #ledger td, #ledger th {
    padding: 8px;
  }

  #majorBookContent table {
    font-size: 0.9em;
  }

  #majorBookContent td, #majorBookContent th {
    padding: 8px;
  }

  #balance table {
    font-size: 0.9em;
  }

  #balance td, #balance th {
    padding: 8px;
  }

  #balance h3 {
    font-size: 1.1em;
    margin-bottom: 10px;
  }

  #balance h4 {
    font-size: 1em;
    margin-top: 10px;
  }

  #balance p {
    font-size: 0.9em;
    margin: 5px 0;
  }

  /* Products list two-column layout */
  #productsList {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 0;
  }

  .product-item {
    padding: 8px;
    border: 1px solid #eee;
    border-radius: 6px;
    background: #fff;
  }

  .product-item strong {
    display: block;
    margin-bottom: 6px;
  }

  .help-button {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
  }

  .help-button:hover {
    transform: scale(1.1);
  }

  .help-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 1001;
  }

  .help-modal h2 {
    color: var(--primary);
    margin-bottom: 20px;
  }

  .help-modal h3 {
    color: var(--accent);
    margin: 15px 0;
  }

  .help-modal p {
    margin: 10px 0;
    line-height: 1.6;
  }

  .help-modal .example {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
  }

  .modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }

  .close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--primary);
  }

  /* Add these new styles */
  .notification-modal {
    display: none;
    position: fixed;
    top: 12%;
    left: 50%;
    transform: translate(-50%, 0);
    background: white;
    padding: 14px 18px;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.22);
    z-index: 2401; /* raised so notifications appear above other modals */
    min-width: 300px;
    max-width: 90%;
    text-align: center;
  }

  .notification-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.15);
    z-index: 2400; /* keep just below notification */
  }

  .notification-content {
    margin: 15px 0;
    font-size: 1.1em;
  }

  .notification-button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  /* Add these new styles for the icons and confirmation modal */
  .action-icon {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    margin: 0 3px;
    font-size: 1.2em;
    transition: transform 0.2s;
  }

  .action-icon:hover {
    transform: scale(1.1);
  }

  .action-icon.edit {
    color: var(--warning);
  }

  .action-icon.delete {
    color: var(--danger); 
  }

  .confirmation-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 2000;
    min-width: 300px;
    text-align: center;
  }

  .confirmation-modal .buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .confirmation-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
  }
  .clear-confirmation-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
  }
  .clear-confirmation-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 2000;
    min-width: 300px;
    text-align: center;
  }
  .clear-confirmation-content {
    margin: 15px 0;
    font-size: 1.1em;
  }
  .clear-confirmation-modal .buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  /* Slide-down modal for catalog view (appears from top) */
  #catalogViewModal {
    position: fixed;
    left: 50%;
    top: -100%;
    transform: translate(-50%, -100%);
    transition: transform 320ms cubic-bezier(.2,.9,.2,1), top 320ms cubic-bezier(.2,.9,.2,1), opacity 320ms;
    opacity: 0;
    display: none;
    z-index: 2250;
    min-width: 800px;
    max-width: 95%;
    width: 85%;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }

  #catalogViewModal.slide-down {
    top: 6%;
    transform: translate(-50%, 0);
    opacity: 1;
    display: block;
  }
</style>
</head>
<body>
<button class="help-button" onclick="showHelp()">?</button>
<div class="modal-backdrop" id="modalBackdrop" onclick="hideHelp()"></div>
<div class="help-modal" id="helpModal">
  <button class="close-modal" onclick="hideHelp()">&times;</button>
  <h2>Introducci√≥n y Prop√≥sito</h2>

  <p>Esta aplicaci√≥n es un entorno educativo para aprender los fundamentos de la contabilidad pr√°ctica: registrar transacciones, generar libros contables y entender c√≥mo afectan el balance. Est√° dise√±ada para practicar registros contables en un cat√°logo simplificado y para sincronizar facturaci√≥n con el libro diario y mayor.</p>

  <h3>Objetivo educativo</h3>
  <p>Aprender a identificar cuentas DEBE y HABER, clasificar tipos de transacciones (ventas, compras, gastos, pagos, cr√©dito, inversi√≥n, financiamiento), y observar c√≥mo cada operaci√≥n impacta el Libro Diario, el Libro Mayor y el Balance General.</p>

  <h3>Descripci√≥n de las opciones del men√∫</h3>
  <ul>
    <li><strong>Ventas:</strong> Lista de productos y facturaci√≥n; al facturar se genera autom√°ticamente la transacci√≥n correspondiente (DEBE: Caja/Bancos, HABER: Ventas) y se sincroniza con la lista de transacciones.</li>
    <li><strong>Compras:</strong> Registro de entradas de mercanc√≠a para aumentar el stock; permite ingresar compras a cr√©dito o pago inmediato, agregar productos nuevos al inventario y, tras procesar la compra, se genera la transacci√≥n contable correspondiente (DEBE: Inventario, HABER: Proveedores/Caja/Bancos) y se sincroniza con la lista de transacciones.</li>
    <li><strong>Transacciones:</strong> Formulario para registrar manualmente transacciones, con selecci√≥n de fecha (la fecha por defecto sugerida es la actual), tipo, monto, cuenta DEBE y cuenta HABER; incluye edici√≥n, eliminaci√≥n, b√∫squeda en las transacciones registradas e importaci√≥n/exportaci√≥n.</li>
    <li><strong>Libro Diario:</strong> Muestra las anotaciones por fecha con las partidas DEBE y HABER desglosadas para cada transacci√≥n.</li>
    <li><strong>Libro Mayor:</strong> Agrupa movimientos por cuenta mostrando los d√©bitos, cr√©ditos y saldo acumulado por cuenta.</li>
    <li><strong>Balance General:</strong> Presenta los Activos (lado izquierdo) y Pasivo + Capital (lado derecho) con totales para verificar que Pasivo + Capital cuadre con Activos.</li>
    <li><strong>Reportes:</strong> Genera PDF o Excel del Libro Diario, Libro Mayor y Balance General para descarga o impresi√≥n.</li>
    <li><strong>Herramientas:</strong> Agrupa utilidades administrativas y de intercambio de datos:
      <ul>
        <li><strong>Empresa:</strong> Formulario para guardar los datos principales de la empresa (Nombre*, Giro, Tel√©fono, Responsable*, Registro, NIT, Correo*). Los campos se presentan priorizados y algunos marcados como requeridos.</li>
        <li><strong>Cat√°logo:</strong> Opci√≥n para descargar o cargar el cat√°logo de cuentas contables en formato JSON y as√≠ reemplazar o restaurar el cat√°logo usado por el sistema.</li>
        <li><strong>Utilidades:</strong> Botones para Guardar Datos, Exportar JSON, Exportar Excel e Importar JSON que permiten exportar/importar las transacciones y respaldar la informaci√≥n del sistema.</li>
      </ul>
    </li>
  </ul>

  <h3>Buenas pr√°cticas al registrar</h3>
  <ol>
    <li>Verifica que las cuentas seleccionadas pertenezcan al cat√°logo mostrado en el sistema.</li>
    <li>Escribe descripciones claras que expliquen la naturaleza de la operaci√≥n.</li>
    <li>Revisa el Libro Diario y el Libro Mayor despu√©s de registrar para entender el efecto en saldos.</li>
  </ol>

  <h3>Ejemplo pr√°ctico</h3>
  <div class="example">
    <h4>Venta en efectivo ‚Äî Caso de ejemplo</h4>
    <p>Imagina que vendes mercanc√≠a por $5,000 en efectivo.</p>
    <ul>
      <li>Tipo: Venta</li>
      <li>Fecha: (la del d√≠a)</li>
      <li>DEBE: 1.1.1.1 - Caja General ($5,000)</li>
      <li>HABER: 4.5.1.1 - Ventas Nacionales ($5,000)</li>
      <li>Descripci√≥n sugerida: "Venta de mercanc√≠a en efectivo ‚Äî recibo #123"</li>
    </ul>
    <p>Al registrar esto en la pesta√±a Transacciones (o al facturar desde Ventas), ver√°s dos entradas en el Libro Diario y los saldos actualizados en el Libro Mayor y Balance General.</p>
  </div>

  <p style="margin-top:20px; font-size:0.9em; color:#666; border-top:1px solid #eee; padding-top:10px;">¬© Derechos reservados a Carlos Alfredo Castillo Flores - ITCPO - 2025</p>
</div>
<div class="notification-backdrop" id="notificationBackdrop"></div>
<div class="notification-modal" id="notificationModal">
  <div class="notification-content" id="notificationContent"></div>
  <button class="notification-button" onclick="hideNotification()">Aceptar</button>
</div>

<!-- Modal for editing a product (purchase side) -->
<div class="modal-backdrop" id="editProductBackdrop" style="display:none;"></div>
<div class="confirmation-modal" id="editProductModal" style="display:none; z-index:2100; min-width:340px;">
  <h3 style="margin-top:0;">Editar Producto</h3>
  <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
    <label style="font-weight:700; font-size:0.95em;">Nombre</label>
    <input id="editProductName" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
    <div id="editNameMsg" style="color:#e74c3c; font-size:0.9em; min-height:18px;"></div>

    <label style="font-weight:700; font-size:0.95em;">Precio de Compra</label>
    <input id="editProductPurchase" type="number" step="0.01" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
    <div id="editPurchaseMsg" style="color:#e74c3c; font-size:0.9em; min-height:18px;"></div>

    <label style="font-weight:700; font-size:0.95em;">Precio de Venta</label>
    <input id="editProductSale" type="number" step="0.01" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
    <div id="editSaleMsg" style="color:#e74c3c; font-size:0.9em; min-height:18px;"></div>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
      <button class="btn btn-danger" onclick="deleteProductFromModal()" type="button">Eliminar</button>
      <button class="btn btn-primary" onclick="saveEditedProduct()" type="button">Guardar</button>
      <button class="btn btn-warning" onclick="cancelEditProduct()" type="button">Cancelar</button>
    </div>
  </div>
</div>
<div class="confirmation-backdrop" id="confirmationBackdrop"></div>
<div class="confirmation-modal" id="confirmationModal">
  <div class="confirmation-content">¬øEst√° seguro de que desea eliminar esta transacci√≥n?</div>
  <div class="buttons">
    <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
    <button class="btn btn-primary" onclick="cancelDelete()">Cancelar</button>
  </div>
</div>
<div class="clear-confirmation-backdrop" id="clearConfirmationBackdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;"></div>
<div class="clear-confirmation-modal" id="clearConfirmationModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 2000; min-width: 300px; text-align: center;">
  <div class="clear-confirmation-content">¬øEst√° seguro de que desea eliminar todas las transacciones?</div>
  <div class="buttons" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
    <button class="btn btn-danger" onclick="confirmClear()">Eliminar</button>
    <button class="btn btn-primary" onclick="cancelClear()">Cancelar</button>
  </div>
</div>

<!-- Company modal (Herramientas -> Empresa) -->
<div class="modal-backdrop" id="companyBackdrop" style="display:none;"></div>
<div class="confirmation-modal" id="companyModal" style="display:none; z-index:2200; min-width:360px;">
  <h3 style="margin-top:0;">Datos de la Empresa</h3>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; align-items:start;">
    <div>
      <label style="font-weight:700;">Nombre de la empresa * </label>
      <input id="companyName" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
      <div id="companyNameMsg" style="color:#e74c3c; font-size:0.9em; min-height:18px;"></div>
    </div>

    <div>
      <label style="font-weight:700;">Responsable * </label>
      <input id="companyResponsible" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
      <div id="companyRespMsg" style="color:#e74c3c; font-size:0.9em; min-height:18px;"></div>
    </div>

    <div>
      <label style="font-weight:700;">Correo del responsable * </label>
      <input id="companyEmail" type="email" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
      <div id="companyEmailMsg" style="color:#e74c3c; font-size:0.9em; min-height:18px;"></div>
    </div>

    <div>
      <label style="font-weight:700;">Giro / Actividad econ√≥mica</label>
      <input id="companyActivity" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
    </div>

    <div>
      <label style="font-weight:700;">Tel√©fono</label>
      <input id="companyPhone" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
    </div>

    <div>
      <label style="font-weight:700;">Registro</label>
      <input id="companyRegistry" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
    </div>

    <div style="grid-column: 1 / 2;">
      <label style="font-weight:700;">NIT</label>
      <input id="companyNIT" type="text" style="padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
    </div>

    <div style="display:flex; gap:10px; justify-content:flex-end; align-items:end;">
      <div style="margin-left:auto;"></div>
      <button class="btn btn-primary" onclick="saveCompany()" type="button">Guardar</button>
      <button class="btn btn-warning" onclick="closeCompanyModal()" type="button">Cancelar</button>
    </div>
  </div>
</div>
<div class="container">
  <h1 style="background-color: #f39c12; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">Sistema Contable by ITCPO</h1>
  
  <div class="tabs">
    <button class="tab active" onclick="showTab(event, 'sales')">Ventas</button>
    <button class="tab" onclick="showTab(event, 'purchases')">Compras</button>
    <button class="tab" onclick="showTab(event, 'transactions')">Transacciones</button>
    <button class="tab" onclick="showTab(event, 'ledger')">Libro Diario</button>
    <button class="tab" onclick="showTab(event, 'majorBook')">Libro Mayor</button>
    <button class="tab" onclick="showTab(event, 'balance')">Balance General</button>
    <button class="tab" onclick="showTab(event, 'reports')">Reportes</button>
    <button class="tab" onclick="showTab(event, 'tools')">Herramientas</button>
  </div>

  <div id="sales" class="content active">
    <h2 style="background-color: #1abc9c; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">Ventas - Facturaci√≥n</h2>
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
      <div style="flex:1; min-width:260px;">
        <h3 style="margin-bottom:10px;">Productos Disponibles</h3>
        <ul id="productsList" style="list-style:none; padding:0;"></ul>
      </div>
      <div style="flex:1; min-width:280px;">
        <h3 style="margin-bottom:10px;">Factura</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <select id="productSelect" style="flex:1;"></select>
          <input id="productQty" type="number" min="1" value="1" style="width:80px; padding:8px; border:1px solid #ddd; border-radius:4px;">
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn btn-primary" onclick="addToInvoice()" type="button">Agregar a Factura</button>
          <button class="btn btn-success" onclick="processInvoice()" type="button">Facturar</button>
        </div>
        <h4 style="margin-top:15px;">Detalle de Factura</h4>
        <table id="invoiceTable" style="width:100%; margin-top:8px;">
          <thead>
            <tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="3" style="text-align:right; font-weight:bold;">Total:</td><td id="invoiceTotal">$0.00</td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>
    <p style="margin-top:14px; color:#666; font-size:0.9em;">Al facturar, se registrar√° autom√°ticamente una transacci√≥n con cuentas DEBE (Caja/Bancos) y HABER (Ventas) y se sincronizar√° con la lista de transacciones.</p>
  </div>

  <div id="purchases" class="content">
    <h2 style="background-color: #f39c12; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">Compras - Entrada de Mercanc√≠a</h2>
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
      <div style="flex:1; min-width:260px;">
        <h3 style="margin-bottom:10px;">Productos en Inventario</h3>
        <ul id="productsListPurchases" style="list-style:none; padding:0;"></ul>
        <h4 style="margin-top:12px;">Agregar Producto Nuevo</h4>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="newProductName" placeholder="Nombre del producto" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <input id="newProductPrice" type="number" min="0" step="0.01" placeholder="Precio" style="width:100px; padding:8px; border:1px solid #ddd; border-radius:4px;">
        </div>
        <button class="btn btn-primary" onclick="addNewProduct()" type="button">Agregar Producto</button>
      </div>
      <div style="flex:1; min-width:280px;">
        <h3 style="margin-bottom:10px;">Registrar Compra</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <select id="purchaseProductSelect" style="flex:1;"></select>
          <input id="purchaseQty" type="number" min="1" value="1" style="width:80px; padding:8px; border:1px solid #ddd; border-radius:4px;">
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="purchasePrice" type="number" min="0" step="0.01" placeholder="Precio unitario" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <select id="purchasePaymentMethod" style="width:160px; padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="2.3.1.1 - Proveedores Nacionales">A cr√©dito - Proveedores</option>
            <option value="1.1.2.1 - Bancos Nacionales">Pago - Bancos</option>
            <option value="1.1.1.1 - Caja General">Pago - Caja</option>
          </select>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn btn-primary" onclick="addToPurchase()" type="button">Agregar a Compra</button>
          <button class="btn btn-success" onclick="processPurchase()" type="button">Registrar Compra</button>
        </div>
        <h4 style="margin-top:15px;">Detalle de Compra</h4>
        <table id="purchaseTable" style="width:100%; margin-top:8px;">
          <thead>
            <tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="3" style="text-align:right; font-weight:bold;">Total:</td><td id="purchaseTotal">$0.00</td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>
    <p style="margin-top:14px; color:#666; font-size:0.9em;">Al registrar la compra se actualizar√° el stock y se generar√° autom√°ticamente la transacci√≥n contable (DEBE: Inventario, HABER: Proveedores/Caja/Bancos) que se sincronizar√° con Transacciones.</p>
  </div>

  <div id="transactions" class="content">
    <h2 style="background-color: #2ecc71; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">Registro de Transacciones</h2>
    <form id="transactionForm">
      <div class="form-row">
        <div class="form-group">
          <label>Fecha:</label>
          <input type="date" id="date" required>
        </div>
        <div class="form-group">
          <label>Tipo de Transacci√≥n:</label>
          <select id="type" required onchange="applySuggestedAccounts()">
            <option value="">Seleccione tipo...</option>
            <option value="venta">Venta</option>
            <option value="compra">Compra</option>
            <option value="gasto">Gasto</option>
            <option value="pago">Pago</option>
            <option value="credito">Cr√©dito</option>
            <option value="inversion">Inversi√≥n</option>
            <option value="financiamiento">Financiamiento</option>
            <option value="ajuste-inventario">Ajuste Inventario</option>
            <option value="ajuste-precio-venta">Ajuste Precio Venta</option>
            <option value="devolucion">Devoluci√≥n de Producto</option>
          </select>
        </div>
        <div class="form-group">
          <label>Monto:</label>
          <input type="number" id="amount" required min="0" step="0.01">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Cuenta Debe:</label>
          <select id="debitAccount" required></select>
        </div>
        <div class="form-group">
          <label>Cuenta Haber:</label>
          <select id="creditAccount" required></select>
        </div>
        <div class="form-group">
          <label>Descripci√≥n:</label>
          <input type="text" id="description" required>
        </div>
      </div>

      <!-- Campos espec√≠ficos para devoluci√≥n (ocultos por defecto) -->
      <div id="returnFields" style="display:none; margin-top:10px;">
        <div class="form-row" style="align-items:center;">
          <div class="form-group" style="flex:1;">
            <label>Producto devuelto:</label>
            <select id="returnProductSelect" style="width:100%;"></select>
          </div>
          <div class="form-group" style="width:140px;">
            <label>Cantidad:</label>
            <input type="number" id="returnQty" min="1" value="1" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
          </div>
        </div>
        <p style="font-size:0.9em; color:#666; margin-top:6px;">Al registrar una devoluci√≥n se incrementar√° el stock del producto y se generar√° la partida contable (DEBE: Inventario, HABER: Ventas).</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn btn-primary">Registrar Transacci√≥n</button>
        <button type="button" onclick="addExampleTransactions()" class="btn btn-success">Ejemplo</button>
        <button type="button" onclick="clearExampleTransactions()" class="btn btn-primary">Limpiar</button>
      </div>

    </form>

    <div class="transactions-list">
      <h3 style="background-color: #f39c12; color: white; padding: 10px; border-radius: 5px; margin-bottom: 12px;">Transacciones Registradas</h3>

      <!-- Search field to filter transactions -->
      <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
        <input id="transactionsSearch" placeholder="Buscar transacci√≥n (fecha, tipo, cuenta, descripci√≥n...)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
        <button class="btn btn-primary" onclick="clearTransactionsSearch()" type="button" style="padding:8px 10px;">Limpiar</button>
      </div>

      <table id="transactionsTable">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Debe</th>
            <th>Haber</th>
            <th>Monto</th>
            <th>Descripci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="ledger" class="content">
    <h2>Libro Diario</h2>
    <table id="ledgerTable">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Descripci√≥n</th>
          <th>Cuenta</th>
          <th>Debe</th>
          <th>Haber</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="majorBook" class="content">
    <h2>Libro Mayor</h2>
    <div id="majorBookContent"></div>
  </div>

  <div id="balance" class="content">
    <h2>Balance General</h2>
    <table id="balanceTable">
      <thead>
        <tr>
          <th>Activo</th>
          <th>Pasivo y Capital</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="reports" class="content">
    <h2>Reportes en PDF</h2>
    <div class="form-row" style="margin-top: 20px;">
      <div class="form-group">
        <button onclick="generateLedgerPDF()" class="btn btn-brown">
          <i class="fas fa-file-pdf"></i> Generar Libro Diario
        </button>
      </div>
      <div class="form-group">
        <button onclick="generateMajorBookPDF()" class="btn btn-orange">
          <i class="fas fa-file-pdf"></i> Generar Libro Mayor
        </button>
      </div>
      <div class="form-group">
        <button onclick="generateBalancePDF()" class="btn btn-black">
          <i class="fas fa-file-pdf"></i> Generar Balance General
        </button>
      </div>
    </div>
  </div>

  <!-- Herramientas -->
  <div id="tools" class="content">
    <h2 style="background-color: #9b59b6; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">Herramientas</h2>
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
      <div style="flex:1; min-width:260px;">
        <h3>Empresa</h3>
        <p style="color:#666; font-size:0.95em; margin-bottom:8px;">Guarda los datos principales de la empresa. Los campos marcados con * son obligatorios.</p>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn btn-primary" onclick="openCompanyModal()" type="button">Empresa</button>
          <button class="btn btn-brown" onclick="openCatalogModal()" type="button">Cat√°logo</button>
        </div>
      </div>

      

      <div style="flex:2; min-width:280px;">
        <h3>Informaci√≥n guardada</h3>
        <div id="companyInfo" style="padding:12px; border:1px solid #eee; border-radius:6px; background:#fff; min-height:120px; color:#333;">
          <em style="color:#888;">No hay informaci√≥n de empresa guardada.</em>
        </div>
      </div>

      <div style="flex:1 1 100%; min-width:260px; margin-top:12px;">
        <h3>Utilidades</h3>
        <p style="color:#666; font-size:0.95em; margin-bottom:8px;">Acciones para guardar y exportar/importar datos del sistema.</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <button class="btn btn-primary" onclick="saveData()" type="button" title="Guardar datos localmente">Guardar Datos</button>
          <button class="btn btn-success" onclick="exportToJSON()" type="button" title="Exportar transacciones a JSON">Exportar JSON</button>
          <button class="btn btn-warning" onclick="exportToExcel()" type="button" title="Exportar a Excel">Exportar Excel</button>
          <button class="btn btn-warning" onclick="document.getElementById('jsonInput').click()" type="button" title="Importar transacciones desde JSON">Importar JSON</button>
          <input type="file" id="jsonInput" style="display: none;" accept=".json">
          <input type="file" id="catalogInput" style="display: none;" accept=".json">
        </div>
      </div>

    </div>
  </div>

  <!-- Catalog modal (simple info) -->
  <div class="modal-backdrop" id="catalogBackdrop" style="display:none;"></div>
  <div class="confirmation-modal" id="catalogModal" style="display:none; z-index:2200; min-width:360px;">
    <h3 style="margin-top:0;">Cat√°logo de Cuentas</h3>
    <div style="margin-top:10px;">
      <p style="color:#666;">Desde aqu√≠ puedes descargar el cat√°logo actual de cuentas, cargar un archivo JSON con la estructura del cat√°logo para reemplazar el actual, o revisar el cat√°logo en detalle.</p>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn btn-primary" onclick="exportAccountsCatalog()" type="button">Descargar</button>
        <button class="btn btn-warning" onclick="document.getElementById('catalogInput').click()" type="button">Cargar</button>
        <button class="btn btn-success" onclick="openCatalogView()" type="button">Ver Cat√°logo</button>
        <button class="btn btn-black" onclick="closeCatalogModal()" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Catalog view modal: muestra tabla editable por tipo -->
  <div class="modal-backdrop" id="catalogViewBackdrop" style="display:none;"></div>
  <div class="confirmation-modal" id="catalogViewModal" style="min-width:800px; max-width:95%; width:85%;">
    <button class="close-modal" onclick="closeCatalogView()" aria-label="Cerrar cat√°logo" style="right:12px; top:8px;">&times;</button>
    <h3 style="margin-top:0;">Ver y Editar Cat√°logo de Cuentas</h3>
    <div style="margin-top:10px; max-height:60vh; overflow:auto;">
      <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
        <strong style="align-self:center;">Filtrar por:</strong>
        <button class="btn btn-primary" onclick="renderCatalogView('activo')" type="button">Activo</button>
        <button class="btn btn-primary" onclick="renderCatalogView('pasivo')" type="button">Pasivo</button>
        <button class="btn btn-primary" onclick="renderCatalogView('capital')" type="button">Capital</button>
        <button class="btn btn-primary" onclick="renderCatalogView('resultados')" type="button">Resultados</button>
        <button class="btn btn-warning" onclick="renderCatalogView()" type="button">Mostrar todo</button>
        <button class="btn btn-success" onclick="openCatalogAddForm()" type="button">Agregar Cuenta</button>
      </div>
      <div id="catalogViewContent"></div>

      <!-- Floating add/edit form for catalog accounts (now a floating panel) -->
      <div id="catalogForm" style="display:none; position:fixed; right:20px; top:10%; width:420px; max-width:90%; padding:14px; border:1px solid #e6e6e6; border-radius:8px; background:#fafafa; box-shadow:0 8px 30px rgba(0,0,0,0.12); z-index:2300;">
        <button class="close-modal" onclick="cancelCatalogForm()" aria-label="Cerrar formulario" style="right:12px; top:8px; position:absolute; background:none; border:none; font-size:20px;">&times;</button>
        <h4 id="catalogFormTitle" style="margin-top:0; margin-bottom:8px;">Agregar Cuenta</h4>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="catalogFormInput" type="text" placeholder='Ej: "1.1.1.1 - Caja General"' style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <select id="catalogFormType" style="width:160px; padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="activo">Activo</option>
            <option value="pasivo">Pasivo</option>
            <option value="capital">Capital</option>
            <option value="resultados">Resultados</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn btn-success" onclick="acceptCatalogForm()" type="button">Aceptar</button>
          <button class="btn btn-primary" onclick="cancelCatalogForm()" type="button">Cancelar</button>
        </div>
        <div id="catalogFormMsg" style="color:#e74c3c; font-size:0.95em; margin-top:8px; min-height:18px;"></div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
        <button class="btn btn-success" onclick="saveCatalogChanges()" type="button">Guardar cambios</button>
        <button class="btn btn-primary" onclick="closeCatalogView()" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  
  <footer style="text-align:center; margin-top:20px; color:#666; font-size:0.9em;">¬© Derechos reservados a Carlos Alfredo Castillo Flores - ITCPO - 2025</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
function formatMoney(amount) {
  return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

const accounts = {
  activo: [
    '1.1.0.0 - Activo Circulante',
    '1.1.1.0 - Caja',
    '1.1.1.1 - Caja General',
    '1.1.2.0 - Bancos',
    '1.1.2.1 - Bancos Nacionales',
    '1.1.2.2 - Bancos Extranjeros',
    '1.1.3.0 - Clientes',
    '1.1.3.1 - Clientes Nacionales', 
    '1.1.3.2 - Clientes Internacionales',
    '1.1.4.0 - Documentos por Cobrar',
    '1.1.5.0 - IVA Acreditable',
    '1.1.6.0 - Inventarios',
    '1.1.6.1 - Inventario de Productos Terminados',
    '1.1.6.2 - Inventario de Materia Prima',
    '1.2.0.0 - Activo No Circulante',
    '1.2.1.0 - Terrenos',
    '1.2.2.0 - Edificios',
    '1.2.3.0 - Mobiliario y Equipo',
    '1.2.3.1 - Mobiliario de Oficina',
    '1.2.3.2 - Equipo de C√≥mputo',
    '1.2.4.0 - Veh√≠culos',
    '1.2.5.0 - Depreciaci√≥n Acumulada'
  ],
  pasivo: [
    '2.3.0.0 - Pasivo Circulante',
    '2.3.1.0 - Proveedores',
    '2.3.1.1 - Proveedores Nacionales',
    '2.3.1.2 - Proveedores Internacionales', 
    '2.3.2.0 - Documentos por Pagar',
    '2.3.3.0 - Acreedores Diversos',
    '2.3.4.0 - IVA por Pagar'
  ],
  capital: [
    '3.4.0.0 - Capital',
    '3.4.1.0 - Capital Social',
    '3.4.2.0 - Reservas de Capital'
  ],
  resultados: [
    '4.5.0.0 - Ingresos',
    '4.5.1.0 - Ventas',
    '4.5.1.1 - Ventas Nacionales',
    '4.5.1.2 - Ventas Internacionales',
    '4.5.2.0 - Devoluciones sobre Ventas',
    '5.6.0.0 - Costo de Ventas',
    '6.7.0.0 - Gastos Operativos',
    '6.7.1.0 - Gastos de Administraci√≥n',
    '6.7.2.0 - Gastos de Ventas',
    '6.7.2.1 - Sueldos y Salarios',
    '6.7.2.2 - Publicidad y Promoci√≥n',
    '6.7.2.3 - Servicios Generales',
    '6.7.2.4 - Luz, Agua y Tel√©fono',
    '6.7.3.0 - Mantenimiento de Equipo',
    '7.8.0.0 - Otros Ingresos',
    '7.8.1.0 - Otros Gastos'
  ]
};

let transactions = [];

// Productos de ejemplo para la secci√≥n Ventas
const products = [
  { id: 'P001', name: 'Camiseta B√°sica', price: 19.99, purchasePrice: 10.00, stock: 50, debitAccount: '1.1.1.1 - Caja General', creditAccount: '4.5.1.1 - Ventas Nacionales' },
  { id: 'P002', name: 'Laptop Modelo A', price: 1299.99, purchasePrice: 900.00, stock: 10, debitAccount: '1.1.2.1 - Bancos Nacionales', creditAccount: '4.5.1.1 - Ventas Nacionales' },
  { id: 'P003', name: 'Mouse Inal√°mbrico', price: 29.99, purchasePrice: 12.00, stock: 75, debitAccount: '1.1.1.1 - Caja General', creditAccount: '4.5.1.1 - Ventas Nacionales' },
  { id: 'P004', name: 'Servicio de Consultor√≠a (paquete)', price: 2000.00, purchasePrice: 0.00, stock: 5, debitAccount: '1.1.2.1 - Bancos Nacionales', creditAccount: '4.5.1.1 - Ventas Nacionales' }
];

let invoiceItems = [];

/* Inicializa lista de productos en DOM para ventas y compras */
function populateProducts() {
  const list = document.getElementById('productsList');
  const sel = document.getElementById('productSelect');
  const listPurch = document.getElementById('productsListPurchases');
  const selPurch = document.getElementById('purchaseProductSelect');
  if (!list || !sel || !listPurch || !selPurch) return;
  list.innerHTML = '';
  sel.innerHTML = '';
  listPurch.innerHTML = '';
  selPurch.innerHTML = '';
  products.forEach(p => {
    // Ventas list (left) - keep compact look
    const li = document.createElement('li');
    li.style.padding = '8px 0';
    li.style.marginBottom = '6px';
    li.innerHTML = `<strong>${p.name}</strong><br><span style="color:#666;">Venta: $${formatMoney(p.price)} ‚Ä¢ Stock: ${p.stock || 0}</span>`;
    list.appendChild(li);

    // Compras list (right) - simple list row (no card)
    const li2 = document.createElement('li');
    li2.style.display = 'flex';
    li2.style.justifyContent = 'space-between';
    li2.style.alignItems = 'center';
    li2.style.padding = '6px 0';
    li2.style.borderBottom = '1px solid #eee';

    const leftDiv = document.createElement('div');
    leftDiv.style.flex = '1';
    leftDiv.innerHTML = `<strong>${p.name}</strong>
                         <div style="color:#666; font-size:0.95em; margin-top:4px;">
                           Precio Venta: $${formatMoney(p.price)} &nbsp;‚Ä¢&nbsp; Precio Compra: $${formatMoney(p.purchasePrice || 0)} &nbsp;‚Ä¢&nbsp; Stock: ${p.stock || 0}
                         </div>`;

    const actionsWrap = document.createElement('div');
    actionsWrap.style.display = 'flex';
    actionsWrap.style.alignItems = 'center';
    actionsWrap.style.gap = '6px';

    const editBtn = document.createElement('button');
    editBtn.className = 'action-icon edit';
    editBtn.title = 'Editar precios';
    editBtn.innerHTML = '‚úèÔ∏è';
    editBtn.onclick = () => openEditProductModal(p.id);

    const delBtn = document.createElement('button');
    delBtn.className = 'action-icon delete';
    delBtn.title = 'Eliminar producto';
    delBtn.innerHTML = 'üóëÔ∏è';
    delBtn.onclick = () => {
      if (confirm('¬øEliminar producto "' + p.name + '"?')) {
        deleteProduct(p.id);
      }
    };

    actionsWrap.appendChild(editBtn);
    actionsWrap.appendChild(delBtn);

    li2.appendChild(leftDiv);
    li2.appendChild(actionsWrap);
    listPurch.appendChild(li2);

    // Selects
    const opt = new Option(`${p.name} ‚Äî $${formatMoney(p.price)}`, p.id);
    sel.add(opt);
    const opt2 = new Option(`${p.name} ‚Äî Stock: ${p.stock || 0}`, p.id);
    selPurch.add(opt2);

    // Also populate return product select if present
    const returnSel = document.getElementById('returnProductSelect');
    if (returnSel) {
      const optR = new Option(`${p.name} ‚Äî Stock: ${p.stock || 0}`, p.id);
      returnSel.add(optR);
    }
  });
}

/* Editar producto: cambiar precio de compra/venta y actualizar listado */
/* Modal-based product editor */
let productBeingEdited = null;

function openEditProductModal(productId) {
  const prod = products.find(p => p.id === productId);
  if (!prod) { showNotification('Producto no encontrado'); return; }
  productBeingEdited = prod.id;
  document.getElementById('editProductName').value = prod.name || '';
  document.getElementById('editProductPurchase').value = prod.purchasePrice !== undefined ? prod.purchasePrice : '';
  document.getElementById('editProductSale').value = prod.price !== undefined ? prod.price : '';
  document.getElementById('editNameMsg').textContent = '';
  document.getElementById('editPurchaseMsg').textContent = '';
  document.getElementById('editSaleMsg').textContent = '';
  document.getElementById('editProductBackdrop').style.display = 'block';
  document.getElementById('editProductModal').style.display = 'block';
}

function validateEditInputs(name, purchase, sale) {
  let ok = true;
  document.getElementById('editNameMsg').textContent = '';
  document.getElementById('editPurchaseMsg').textContent = '';
  document.getElementById('editSaleMsg').textContent = '';

  if (!name || !name.trim()) {
    document.getElementById('editNameMsg').textContent = 'El nombre es obligatorio.';
    ok = false;
  }
  if (isNaN(purchase) || purchase < 0) {
    document.getElementById('editPurchaseMsg').textContent = 'Precio de compra inv√°lido.';
    ok = false;
  }
  if (isNaN(sale) || sale < 0) {
    document.getElementById('editSaleMsg').textContent = 'Precio de venta inv√°lido.';
    ok = false;
  }
  return ok;
}

function saveEditedProduct() {
  if (!productBeingEdited) return;
  const name = document.getElementById('editProductName').value;
  const purchase = parseFloat(document.getElementById('editProductPurchase').value || '0');
  const sale = parseFloat(document.getElementById('editProductSale').value || '0');

  if (!validateEditInputs(name, purchase, sale)) return;

  const prod = products.find(p => p.id === productBeingEdited);
  if (!prod) { showNotification('Producto no encontrado'); cancelEditProduct(); return; }

  // Keep previous values to calculate adjustments
  const prevPurchase = prod.purchasePrice !== undefined ? prod.purchasePrice : 0;
  const prevSale = prod.price !== undefined ? prod.price : 0;
  const stock = prod.stock || 0;

  // Update product fields
  prod.name = name.trim();
  prod.purchasePrice = parseFloat(purchase.toFixed(2));
  prod.price = parseFloat(sale.toFixed(2));

  // Generate adjustment transactions when purchase price changes (affects inventory valuation)
  const purchaseDiffPerUnit = parseFloat((prod.purchasePrice - prevPurchase).toFixed(2));
  if (Math.abs(purchaseDiffPerUnit) >= 0.01 && stock > 0) {
    const totalAdjustment = parseFloat((purchaseDiffPerUnit * stock).toFixed(2));
    if (totalAdjustment !== 0) {
      const today = new Date().toISOString().split('T')[0];
      // If inventory value increased -> debit Inventario, credit Ajuste por valoraci√≥n (usar cuenta de Capital/Resultados si no hay espec√≠fica)
      // If decreased -> reverse
      const debitAccount = '1.1.6.1 - Inventario de Productos Terminados';
      const creditAccount = '3.4.0.0 - Capital'; // cuenta gen√©rica de ajuste
      const adjTransaction = {
        date: today,
        type: 'ajuste-inventario',
        debitAccount: totalAdjustment > 0 ? debitAccount : creditAccount,
        creditAccount: totalAdjustment > 0 ? creditAccount : debitAccount,
        amount: Math.abs(totalAdjustment),
        description: `Ajuste por cambio en precio de compra de ${prod.name} (Œî $${formatMoney(purchaseDiffPerUnit)} por unidad, stock ${stock})`,
        debitCode: (totalAdjustment > 0 ? debitAccount.split(' - ')[0] : creditAccount.split(' - ')[0]),
        creditCode: (totalAdjustment > 0 ? creditAccount.split(' - ')[0] : debitAccount.split(' - ')[0])
      };
      transactions.push(adjTransaction);
    }
  }

  // Generate a memo adjustment when sale price changes (optional impact on resultados/capital, based on stock)
  const saleDiffPerUnit = parseFloat((prod.price - prevSale).toFixed(2));
  if (Math.abs(saleDiffPerUnit) >= 0.01 && stock > 0) {
    const totalSaleImpact = parseFloat((saleDiffPerUnit * stock).toFixed(2));
    if (totalSaleImpact !== 0) {
      const today = new Date().toISOString().split('T')[0];
      // Use Ventas y Capital as representative accounts for sale price revaluation effect
      const debitAccount = totalSaleImpact < 0 ? '4.5.1.1 - Ventas Nacionales' : '3.4.0.0 - Capital';
      const creditAccount = totalSaleImpact < 0 ? '3.4.0.0 - Capital' : '4.5.1.1 - Ventas Nacionales';
      const saleAdj = {
        date: today,
        type: 'ajuste-precio-venta',
        debitAccount,
        creditAccount,
        amount: Math.abs(totalSaleImpact),
        description: `Ajuste por cambio en precio de venta de ${prod.name} (Œî $${formatMoney(saleDiffPerUnit)} por unidad, stock ${stock})`,
        debitCode: debitAccount.split(' - ')[0],
        creditCode: creditAccount.split(' - ')[0]
      };
      transactions.push(saleAdj);
    }
  }

  productBeingEdited = null;
  document.getElementById('editProductBackdrop').style.display = 'none';
  document.getElementById('editProductModal').style.display = 'none';
  populateProducts();
  updateTransactionsTable();
  saveToLocalStorage();
  showNotification('Producto actualizado' + ((Math.abs(purchaseDiffPerUnit) >= 0.01 && stock > 0) || (Math.abs(saleDiffPerUnit) >= 0.01 && stock > 0) ? ' y se generaron transacciones de ajuste' : ''));
}

function cancelEditProduct() {
  productBeingEdited = null;
  document.getElementById('editProductBackdrop').style.display = 'none';
  document.getElementById('editProductModal').style.display = 'none';
}

function deleteProductFromModal() {
  if (!productBeingEdited) return;
  if (!confirm('¬øEliminar producto? Esta acci√≥n no se puede deshacer.')) return;
  deleteProduct(productBeingEdited);
  productBeingEdited = null;
  document.getElementById('editProductBackdrop').style.display = 'none';
  document.getElementById('editProductModal').style.display = 'none';
}

function deleteProduct(productId) {
  const idx = products.findIndex(p => p.id === productId);
  if (idx === -1) { showNotification('Producto no encontrado'); return; }
  products.splice(idx, 1);
  populateProducts();
  saveToLocalStorage();
  showNotification('Producto eliminado');
}

/* Agrega producto a la factura temporal */
function addToInvoice() {
  const prodId = document.getElementById('productSelect').value;
  const qty = Math.max(1, parseInt(document.getElementById('productQty').value || '1', 10));
  const prod = products.find(p => p.id === prodId);
  if (!prod) { showNotification('Seleccione un producto v√°lido'); return; }

  // Check available stock before adding
  const existing = invoiceItems.find(i => i.id === prodId);
  const existingQty = existing ? existing.qty : 0;
  const available = prod.stock || 0;
  if (existingQty + qty > available) {
    showNotification(`Stock insuficiente para "${prod.name}". Disponible: ${available - existingQty}`);
    return;
  }

  if (existing) existing.qty += qty; else invoiceItems.push({ ...prod, qty });
  renderInvoice();
}

/* --- Funciones para Compras --- */
let purchaseItems = [];

function addNewProduct() {
  const name = document.getElementById('newProductName').value.trim();
  const price = parseFloat(document.getElementById('newProductPrice').value || '0');
  if (!name || isNaN(price) || price <= 0) { showNotification('Ingrese nombre y precio v√°lidos para el producto'); return; }
  const id = 'P' + String(Math.floor(1000 + Math.random() * 9000));
  const newProd = { id, name, price: parseFloat(price.toFixed(2)), stock: 0, debitAccount: '1.1.6.1 - Inventario de Productos Terminados', creditAccount: '4.5.1.1 - Ventas Nacionales' };
  products.push(newProd);
  populateProducts();
  saveToLocalStorage();
  showNotification('Producto agregado al inventario (stock 0). Ahora reg√≠strelo en Compras si desea incrementar stock.');
  document.getElementById('newProductName').value = '';
  document.getElementById('newProductPrice').value = '';
}

function addToPurchase() {
  const prodId = document.getElementById('purchaseProductSelect').value;
  const qty = Math.max(1, parseInt(document.getElementById('purchaseQty').value || '1', 10));
  const price = parseFloat(document.getElementById('purchasePrice').value || '0');
  const prod = products.find(p => p.id === prodId);
  if (!prod) { showNotification('Seleccione un producto v√°lido'); return; }
  if (!price || price <= 0) { showNotification('Ingrese precio unitario v√°lido'); return; }
  const existing = purchaseItems.find(i => i.id === prodId && i.price === price);
  if (existing) existing.qty += qty; else purchaseItems.push({ id: prodId, name: prod.name, price: parseFloat(price.toFixed(2)), qty });
  renderPurchase();
}

function renderPurchase() {
  const tbody = document.querySelector('#purchaseTable tbody');
  tbody.innerHTML = '';
  let total = 0;
  purchaseItems.forEach((it, idx) => {
    const subtotal = it.price * it.qty;
    total += subtotal;
    const row = tbody.insertRow();
    row.innerHTML = `<td>${it.name}</td><td>${it.qty}</td><td>$${formatMoney(it.price)}</td><td>$${formatMoney(subtotal)}</td><td><button class="btn" onclick="removePurchaseItem(${idx})" style="background:#e74c3c; padding:6px 8px; border-radius:4px;">Eliminar</button></td>`;
  });
  document.getElementById('purchaseTotal').textContent = `$${formatMoney(total)}`;
}

function removePurchaseItem(index) {
  purchaseItems.splice(index, 1);
  renderPurchase();
}

function processPurchase() {
  if (purchaseItems.length === 0) { showNotification('No hay items en la compra'); return; }
  const paymentAccount = document.getElementById('purchasePaymentMethod').value || '2.3.1.1 - Proveedores Nacionales';
  let total = 0;
  purchaseItems.forEach(it => total += it.price * it.qty);
  // Update stock for each product
  purchaseItems.forEach(it => {
    const prod = products.find(p => p.id === it.id);
    if (prod) {
      prod.stock = (prod.stock || 0) + it.qty;
      // Ensure inventory debit account exists on product
      if (!prod.debitAccount) prod.debitAccount = '1.1.6.1 - Inventario de Productos Terminados';
    }
  });

  const today = new Date().toISOString().split('T')[0];
  const description = 'Compra: ' + purchaseItems.map(i => `${i.qty}x ${i.name}`).join(', ');
  const transaction = {
    date: today,
    type: 'compra',
    debitAccount: '1.1.6.1 - Inventario de Productos Terminados',
    creditAccount: paymentAccount,
    amount: parseFloat(total.toFixed(2)),
    description,
    debitCode: '1.1.6.1',
    creditCode: paymentAccount.split(' - ')[0]
  };
  transactions.push(transaction);
  updateTransactionsTable();
  saveToLocalStorage();
  purchaseItems = [];
  renderPurchase();
  populateProducts();
  showNotification('Compra registrada, stock actualizado y transacci√≥n sincronizada');
}

// Renderiza tabla de factura
function renderInvoice() {
  const tbody = document.querySelector('#invoiceTable tbody');
  tbody.innerHTML = '';
  let total = 0;
  invoiceItems.forEach((it, idx) => {
    const subtotal = it.price * it.qty;
    total += subtotal;
    const row = tbody.insertRow();
    row.innerHTML = `<td>${it.name}</td><td>${it.qty}</td><td>$${formatMoney(it.price)}</td><td>$${formatMoney(subtotal)}</td><td><button class="btn" onclick="removeInvoiceItem(${idx})" style="background:#e74c3c; padding:6px 8px; border-radius:4px;">Eliminar</button></td>`;
  });
  document.getElementById('invoiceTotal').textContent = `$${formatMoney(total)}`;
}

// Remueve item de factura
function removeInvoiceItem(index) {
  invoiceItems.splice(index, 1);
  renderInvoice();
}

// Procesa la factura: crea una transacci√≥n por el total y sincroniza con la lista de transacciones
function processInvoice() {
  if (invoiceItems.length === 0) { showNotification('No hay items en la factura'); return; }

  // Verify stocks again before processing (in case of race/changes)
  for (const it of invoiceItems) {
    const prod = products.find(p => p.id === it.id);
    const available = prod ? (prod.stock || 0) : 0;
    if (!prod) { showNotification(`Producto no encontrado: ${it.name}`); return; }
    if (it.qty > available) {
      showNotification(`Stock insuficiente para "${it.name}". Disponible: ${available}`);
      return;
    }
  }

  // Sumar total y decidir cuenta de cobro: si alguno tiene debitAccount Bancos usar Bancos, sino Caja
  let total = 0;
  let selectedDebit = null;
  invoiceItems.forEach(it => {
    total += it.price * it.qty;
    if (!selectedDebit && it.debitAccount && it.debitAccount.includes('Bancos')) selectedDebit = it.debitAccount;
    if (!selectedDebit && it.debitAccount && it.debitAccount.includes('Caja')) selectedDebit = it.debitAccount;
  });
  if (!selectedDebit) selectedDebit = '1.1.1.1 - Caja General';
  const creditAccount = '4.5.1.1 - Ventas Nacionales';
  const today = new Date().toISOString().split('T')[0];
  const description = 'Factura: ' + invoiceItems.map(i => `${i.qty}x ${i.name}`).join(', ');
  const transaction = {
    date: today,
    type: 'venta',
    debitAccount: selectedDebit,
    creditAccount: creditAccount,
    amount: parseFloat(total.toFixed(2)),
    description,
    debitCode: selectedDebit.split(' - ')[0],
    creditCode: creditAccount.split(' - ')[0]
  };

  // Disminuir stock por cada item vendido
  invoiceItems.forEach(it => {
    const prod = products.find(p => p.id === it.id);
    if (prod) {
      prod.stock = Math.max(0, (prod.stock || 0) - it.qty);
    }
  });

  // A√±adir a transacciones, actualizar tablas y sincronizar almacenamiento
  transactions.push(transaction);
  updateTransactionsTable();
  populateProducts();
  saveToLocalStorage();

  // Limpiar factura
  invoiceItems = [];
  renderInvoice();
  showNotification('Factura registrada, stock actualizado y transacci√≥n sincronizada');
}

// Asegura que productos est√©n cargados al iniciar

 // Inicializaci√≥n
  document.addEventListener('DOMContentLoaded', () => {
    populateAccountSelects();
    populateProducts();
    loadFromLocalStorage();
    document.getElementById('transactionForm').addEventListener('submit', handleTransaction);

    // Set default date to today in the transaction form
    const dateInput = document.getElementById('date');
    if (dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
    }

    // Wire search box for transactions filtering
    const searchInput = document.getElementById('transactionsSearch');
    if (searchInput) {
      searchInput.addEventListener('input', filterTransactions);
    }

    // Wire catalog file input change to importAccountsCatalog (prevents null when invoking .click())
    const catalogInput = document.getElementById('catalogInput');
    if (catalogInput) {
      catalogInput.addEventListener('change', importAccountsCatalog);
    }
  });

  // Filter transactions table rows by search text
  function filterTransactions() {
    const q = (document.getElementById('transactionsSearch').value || '').trim().toLowerCase();
    const tbody = document.querySelector('#transactionsTable tbody');
    if (!tbody) return;
    Array.from(tbody.rows).forEach(row => {
      const text = Array.from(row.cells).map(c => c.textContent || '').join(' ').toLowerCase();
      row.style.display = q === '' || text.includes(q) ? '' : 'none';
    });
  }

  function clearTransactionsSearch() {
    const el = document.getElementById('transactionsSearch');
    if (el) {
      el.value = '';
      filterTransactions();
      el.focus();
    }
  }

function populateAccountSelects() {
  const debitSelect = document.getElementById('debitAccount');
  const creditSelect = document.getElementById('creditAccount');
  
  // Clear existing options
  debitSelect.innerHTML = '<option value="">Seleccione cuenta...</option>';
  creditSelect.innerHTML = '<option value="">Seleccione cuenta...</option>';
  
  // Add all accounts from catalog
  Object.values(accounts).flat().forEach(account => {
    if (!account || !account.trim()) return; // Skip empty accounts
    debitSelect.add(new Option(account, account));
    creditSelect.add(new Option(account, account));
  });
}

/* Suggested accounts mapping by transaction type */

// --- Funciones para exportar/importar cat√°logo de cuentas ---
function exportAccountsCatalog() {
  try {
    const catalog = {
      activo: accounts.activo || [],
      pasivo: accounts.pasivo || [],
      capital: accounts.capital || [],
      resultados: accounts.resultados || []
    };
    const dataStr = JSON.stringify(catalog, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', 'catalogo_cuentas.json');
    document.body.appendChild(linkElement);
    linkElement.click();
    document.body.removeChild(linkElement);
    showNotification('Cat√°logo de cuentas descargado');
  } catch (e) {
    showNotification('Error al descargar cat√°logo');
  }
}

function importAccountsCatalog(e) {
  const file = e && e.target && e.target.files ? e.target.files[0] : null;
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const parsed = JSON.parse(evt.target.result);
      // Expecting object with arrays for activo, pasivo, capital, resultados
      if (!parsed || typeof parsed !== 'object') throw new Error('Formato inv√°lido');
      const newAccounts = {
        activo: Array.isArray(parsed.activo) ? parsed.activo : accounts.activo,
        pasivo: Array.isArray(parsed.pasivo) ? parsed.pasivo : accounts.pasivo,
        capital: Array.isArray(parsed.capital) ? parsed.capital : accounts.capital,
        resultados: Array.isArray(parsed.resultados) ? parsed.resultados : accounts.resultados
      };
      // Replace in-memory accounts and refresh selects and views
      accounts.activo = newAccounts.activo;
      accounts.pasivo = newAccounts.pasivo;
      accounts.capital = newAccounts.capital;
      accounts.resultados = newAccounts.resultados;
      populateAccountSelects();
      updateTransactionsTable();
      updateMajorBook();
      updateBalance();
      showNotification('Cat√°logo de cuentas cargado correctamente');
      // clear file input
      const inp = document.getElementById('catalogInput');
      if (inp) inp.value = '';
    } catch (err) {
      showNotification('Error al cargar cat√°logo: formato inv√°lido');
      const inp = document.getElementById('catalogInput');
      if (inp) inp.value = '';
    }
  };
  reader.readAsText(file);
}

function openCatalogModal() {
  const bd = document.getElementById('catalogBackdrop');
  const md = document.getElementById('catalogModal');
  if (bd) bd.style.display = 'block';
  if (md) md.style.display = 'block';
}

function closeCatalogModal() {
  const bd = document.getElementById('catalogBackdrop');
  const md = document.getElementById('catalogModal');
  if (bd) bd.style.display = 'none';
  if (md) md.style.display = 'none';
}

/* --- Cat√°logo: vista y edici√≥n r√°pida --- */
function openCatalogView() {
  renderCatalogView(); // default show all
  const bd = document.getElementById('catalogViewBackdrop');
  const md = document.getElementById('catalogViewModal');
  if (bd) bd.style.display = 'block';
  if (md) {
    // ensure it's hidden then trigger slide-down for animation
    md.classList.remove('slide-down');
    md.style.display = 'block';
    // small timeout to allow browser to apply initial state before adding class
    setTimeout(() => md.classList.add('slide-down'), 20);
  }
}

function closeCatalogView() {
  const bd = document.getElementById('catalogViewBackdrop');
  const md = document.getElementById('catalogViewModal');
  if (md) {
    // start slide-up animation then hide
    md.classList.remove('slide-down');
    // after animation ends, hide elements
    setTimeout(() => {
      md.style.display = 'none';
      if (bd) bd.style.display = 'none';
    }, 340);
  } else {
    if (bd) bd.style.display = 'none';
  }
}

/* Renders the catalog table; optional filterType: 'activo'|'pasivo'|'capital'|'resultados' or undefined for all */
function renderCatalogView(filterType) {
  const container = document.getElementById('catalogViewContent');
  if (!container) return;
  const types = ['activo','pasivo','capital','resultados'];
  const toShow = filterType ? [filterType] : types;
  container.innerHTML = '';

  toShow.forEach(type => {
    const list = accounts[type] || [];
    const section = document.createElement('div');
    section.style.marginBottom = '14px';
    section.innerHTML = `<h4 style="margin-bottom:8px; text-transform:capitalize;">${type}</h4>`;
    if (list.length === 0) {
      section.innerHTML += '<div style="color:#888;">(Sin cuentas)</div>';
      container.appendChild(section);
      return;
    }
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">#</th><th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Cuenta</th><th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Acciones</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    list.forEach((acct, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="padding:8px; border-bottom:1px solid #f1f1f1; width:50px;">${idx+1}</td>
                      <td style="padding:8px; border-bottom:1px solid #f1f1f1;">${escapeHtml(acct)}</td>
                      <td style="padding:8px; border-bottom:1px solid #f1f1f1; width:120px;">
                        <button class="action-icon edit" title="Editar" onclick="openCatalogEditForm('${type}', ${idx})">‚úèÔ∏è</button>
                        <button class="action-icon delete" title="Eliminar" onclick="deleteCatalogAccount('${type}', ${idx})">üóëÔ∏è</button>
                      </td>`;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    section.appendChild(table);
    container.appendChild(section);
  });
}

/* Add new account via prompt, determine type by account code and re-sort the list */
/* Open inline form to add a new catalog account */
function openCatalogAddForm() {
  document.getElementById('catalogFormTitle').textContent = 'Agregar Cuenta';
  document.getElementById('catalogFormInput').value = '';
  document.getElementById('catalogFormMsg').textContent = '';
  document.getElementById('catalogFormType').value = 'activo';
  document.getElementById('catalogForm').style.display = 'block';
  // focus input
  setTimeout(() => document.getElementById('catalogFormInput').focus(), 50);
}

/* Open inline form to edit an existing account */
let catalogEditContext = null; // { type, index }
function openCatalogEditForm(type, index) {
  const current = (accounts[type] && accounts[type][index]) || '';
  catalogEditContext = { type, index };
  document.getElementById('catalogFormTitle').textContent = 'Editar Cuenta';
  document.getElementById('catalogFormInput').value = current;
  document.getElementById('catalogFormMsg').textContent = '';
  document.getElementById('catalogFormType').value = type;
  document.getElementById('catalogForm').style.display = 'block';
  setTimeout(() => document.getElementById('catalogFormInput').focus(), 50);
}

/* Accept handler for both add and edit */
function acceptCatalogForm() {
  const value = (document.getElementById('catalogFormInput').value || '').trim();
  const forcedType = document.getElementById('catalogFormType').value;
  const msgEl = document.getElementById('catalogFormMsg');
  msgEl.textContent = '';

  if (!value) {
    msgEl.textContent = 'La cuenta no puede estar vac√≠a.';
    return;
  }
  const parts = value.split(' - ');
  const code = parts[0] ? parts[0].trim() : '';
  if (!code) {
    msgEl.textContent = 'Formato inv√°lido. Debe incluir c√≥digo y descripci√≥n.';
    return;
  }

  // If editing existing account
  if (catalogEditContext) {
    const { type, index } = catalogEditContext;
    accounts[type][index] = value;
    // If user changed type in select, move to new type
    if (type !== forcedType) {
      // remove from old
      accounts[type].splice(index, 1);
      accounts[forcedType] = accounts[forcedType] || [];
      if (!accounts[forcedType].includes(value)) accounts[forcedType].push(value);
      accounts[forcedType].sort(compareAccountsByCode);
    } else {
      accounts[type].sort(compareAccountsByCode);
    }
    catalogEditContext = null;
    populateAccountSelects();
    renderCatalogView();
    showNotification('Cuenta actualizada');
    document.getElementById('catalogForm').style.display = 'none';
    return;
  }

  // Adding new account: determine target type from code if user left default, otherwise allow forcedType
  const firstDigit = code.split('.')[0] || '';
  let targetType = 'resultados';
  if (firstDigit === '1') targetType = 'activo';
  else if (firstDigit === '2') targetType = 'pasivo';
  else if (firstDigit === '3') targetType = 'capital';
  else targetType = forcedType || 'resultados';

  accounts[targetType] = accounts[targetType] || [];
  if (accounts[targetType].includes(value)) {
    msgEl.textContent = 'La cuenta ya existe en el cat√°logo';
    return;
  }
  accounts[targetType].push(value);
  accounts[targetType].sort(compareAccountsByCode);
  populateAccountSelects();
  renderCatalogView();
  document.getElementById('catalogForm').style.display = 'none';
  showNotification(`Cuenta agregada a ${targetType} y cat√°logo reordenado`);
}

/* Cancel add/edit */
function cancelCatalogForm() {
  catalogEditContext = null;
  document.getElementById('catalogForm').style.display = 'none';
  document.getElementById('catalogFormMsg').textContent = '';
}

/* Compare function: sort by numeric code segments before ' - ' */
function compareAccountsByCode(a, b) {
  try {
    const ca = (a.split(' - ')[0] || '').split('.').map(s => parseInt(s, 10) || 0);
    const cb = (b.split(' - ')[0] || '').split('.').map(s => parseInt(s, 10) || 0);
    const len = Math.max(ca.length, cb.length);
    for (let i = 0; i < len; i++) {
      const na = ca[i] || 0;
      const nb = cb[i] || 0;
      if (na < nb) return -1;
      if (na > nb) return 1;
    }
    return a.localeCompare(b);
  } catch (e) {
    return a.localeCompare(b);
  }
}

/* Prompt to edit a single account */
/* (Replaced) promptEditCatalog now uses inline editor openCatalogEditForm */

/* Delete an account from catalog */
function deleteCatalogAccount(type, index) {
  if (!confirm('¬øEliminar esta cuenta del cat√°logo?')) return;
  if (!accounts[type] || !accounts[type][index]) return;
  accounts[type].splice(index, 1);
  populateAccountSelects();
  renderCatalogView(type);
  showNotification('Cuenta eliminada del cat√°logo');
}

/* Save changes (writes current in-memory accounts to localStorage for persistence) */
function saveCatalogChanges() {
  // store a simple catalog object to localStorage
  try {
    const catalog = {
      activo: accounts.activo || [],
      pasivo: accounts.pasivo || [],
      capital: accounts.capital || [],
      resultados: accounts.resultados || []
    };
    localStorage.setItem('accountingAccountsCatalog', JSON.stringify(catalog));
    showNotification('Cambios en el cat√°logo guardados (local)');
  } catch (e) {
    showNotification('Error al guardar cat√°logo');
  }
}

/* small helper to safely escape HTML when injecting account strings */
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, (s) => {
    const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' };
    return map[s] || s;
  });
}
function applySuggestedAccounts() {
  const type = document.getElementById('type').value;
  const debitSelect = document.getElementById('debitAccount');
  const creditSelect = document.getElementById('creditAccount');

  // Show/hide return-specific fields when selecting devoluci√≥n
  const returnFields = document.getElementById('returnFields');
  if (returnFields) {
    if (type === 'devolucion') {
      returnFields.style.display = 'block';
      // ensure return product select is populated
      populateReturnSelect();
    } else {
      returnFields.style.display = 'none';
    }
  }

  // Default fallback (keep first non-empty option)
  const firstDebit = debitSelect.options.length > 1 ? debitSelect.options[1].value : debitSelect.options[0].value;
  const firstCredit = creditSelect.options.length > 1 ? creditSelect.options[1].value : creditSelect.options[0].value;

  const suggestions = {
    venta: { debit: '1.1.1.1 - Caja General', credit: '4.5.1.1 - Ventas Nacionales' },
    compra: { debit: '1.1.6.1 - Inventario de Productos Terminados', credit: '2.3.1.1 - Proveedores Nacionales' },
    gasto: { debit: '6.7.2.4 - Luz, Agua y Tel√©fono', credit: '1.1.2.1 - Bancos Nacionales' },
    pago: { debit: '2.3.1.1 - Proveedores Nacionales', credit: '1.1.2.1 - Bancos Nacionales' },
    credito: { debit: '1.1.3.1 - Clientes Nacionales', credit: '4.5.1.1 - Ventas Nacionales' },
    inversion: { debit: '1.1.2.1 - Bancos Nacionales', credit: '3.4.1.0 - Capital Social' },
    financiamiento: { debit: '1.1.2.1 - Bancos Nacionales', credit: '2.3.2.0 - Documentos por Pagar' },
    'ajuste-inventario': { debit: '1.1.6.1 - Inventario de Productos Terminados', credit: '3.4.0.0 - Capital' },
    'ajuste-precio-venta': { debit: '3.4.0.0 - Capital', credit: '4.5.1.1 - Ventas Nacionales' },
    'devolucion': { debit: '1.1.6.1 - Inventario de Productos Terminados', credit: '4.5.1.1 - Ventas Nacionales' }
  };

  const s = suggestions[type] || { debit: firstDebit, credit: firstCredit };

  // Only apply suggestions if options exist in selects; otherwise keep current
  function setIfExists(selectEl, value) {
    for (let i = 0; i < selectEl.options.length; i++) {
      if (selectEl.options[i].value === value) {
        selectEl.value = value;
        return true;
      }
    }
    // if not found, don't change
    return false;
  }

  setIfExists(debitSelect, s.debit);
  setIfExists(creditSelect, s.credit);
}

// Populate return product select (called when needed)
function populateReturnSelect() {
  const returnSel = document.getElementById('returnProductSelect');
  if (!returnSel) return;
  // clear and add current products
  const current = returnSel.value;
  returnSel.innerHTML = '';
  products.forEach(p => {
    const opt = new Option(`${p.name} ‚Äî Stock: ${p.stock || 0}`, p.id);
    returnSel.add(opt);
  });
  // try to restore previous selection if still exists
  if (current) {
    for (let i=0;i<returnSel.options.length;i++) {
      if (returnSel.options[i].value === current) {
        returnSel.value = current;
        break;
      }
    }
  }
}

function showTab(event, tabName) {
  document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
  
  if (tabName === 'ledger') updateLedger();
  if (tabName === 'majorBook') updateMajorBook();
  if (tabName === 'balance') updateBalance();
}

function handleTransaction(e) {
  e.preventDefault();
  
  const typeVal = document.getElementById('type').value;
  const debitAccount = document.getElementById('debitAccount').value;
  const creditAccount = document.getElementById('creditAccount').value;

  // Validate accounts exist in catalog (for normal and devoluci√≥n flow)
  const allAccounts = Object.values(accounts).flat();

  if (typeVal === 'devolucion') {
    // Devoluci√≥n: must have product and qty
    const productId = document.getElementById('returnProductSelect').value;
    const qty = Math.max(1, parseInt(document.getElementById('returnQty').value || '1', 10));
    if (!productId) { showNotification('Seleccione el producto devuelto'); return; }
    const prod = products.find(p=>p.id === productId);
    if (!prod) { showNotification('Producto seleccionado no existe'); return; }

    // Determine amount: prefer amount input if provided, else use product price * qty
    let amountVal = parseFloat(document.getElementById('amount').value || '0');
    if (!amountVal || amountVal <= 0) {
      amountVal = parseFloat(((prod.price || 0) * qty).toFixed(2));
    }

    // Ensure suggested accounts exist in current catalog
    const debitSuggested = '1.1.6.1 - Inventario de Productos Terminados';
    const creditSuggested = '4.5.1.1 - Ventas Nacionales';
    if (!allAccounts.includes(debitSuggested) || !allAccounts.includes(creditSuggested)) {
      showNotification('El cat√°logo actual no contiene las cuentas necesarias para registrar una devoluci√≥n');
      return;
    }

    // Update stock: reincorporar cantidad
    prod.stock = (prod.stock || 0) + qty;

    const today = document.getElementById('date').value || new Date().toISOString().split('T')[0];
    const description = document.getElementById('description').value || `Devoluci√≥n de ${qty} x ${prod.name}`;

    const transaction = {
      date: today,
      type: 'devolucion',
      debitAccount: debitSuggested,
      creditAccount: creditSuggested,
      amount: parseFloat(amountVal.toFixed(2)),
      description,
      debitCode: debitSuggested.split(' - ')[0],
      creditCode: creditSuggested.split(' - ')[0]
    };

    transactions.push(transaction);
    updateTransactionsTable();
    populateProducts();
    saveToLocalStorage();
    showNotification(`Devoluci√≥n registrada: ${qty} unidad(es) reincorporadas a stock y partida contable generada`);
    e.target.reset();
    // hide return fields after submit
    const returnFields = document.getElementById('returnFields');
    if (returnFields) returnFields.style.display = 'none';
    return;
  }

  // Normal transaction flow
  if (!allAccounts.includes(debitAccount) || !allAccounts.includes(creditAccount)) {
    showNotification('Por favor seleccione cuentas v√°lidas del cat√°logo cargado');
    return;
  }

  const transaction = {
    date: document.getElementById('date').value,
    type: document.getElementById('type').value,
    debitAccount: debitAccount,
    creditAccount: creditAccount,
    amount: parseFloat(document.getElementById('amount').value),
    description: document.getElementById('description').value,
    debitCode: debitAccount.split(' - ')[0],
    creditCode: creditAccount.split(' - ')[0]
  };

  transactions.push(transaction);
  updateTransactionsTable();
  saveToLocalStorage();
  e.target.reset();
}

function updateTransactionsTable() {
  const tbody = document.querySelector('#transactionsTable tbody');
  tbody.innerHTML = '';
  
  transactions.forEach((t, index) => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${t.date}</td>
      <td>${t.type}</td>
      <td>${t.debitAccount}</td>
      <td>${t.creditAccount}</td>
      <td>$${formatMoney(t.amount)}</td>
      <td>${t.description}</td>
      <td>
        <button class="action-icon edit" onclick="editTransaction(${index})" title="Editar">
          ‚úèÔ∏è
        </button>
        <button class="action-icon delete" onclick="showDeleteConfirmation(${index})" title="Eliminar">
          üóëÔ∏è
        </button>
      </td>
    `;
  });
}

function editTransaction(index) {
  const transaction = transactions[index];
  
  // Validate accounts exist in current catalog
  const allAccounts = Object.values(accounts).flat();
  if (!allAccounts.includes(transaction.debitAccount) || 
      !allAccounts.includes(transaction.creditAccount)) {
    showNotification('Esta transacci√≥n contiene cuentas que no existen en el cat√°logo actual');
    return;
  }
  
  // Fill form with transaction data
  document.getElementById('date').value = transaction.date;
  document.getElementById('type').value = transaction.type;
  document.getElementById('debitAccount').value = transaction.debitAccount;
  document.getElementById('creditAccount').value = transaction.creditAccount;
  document.getElementById('amount').value = transaction.amount;
  document.getElementById('description').value = transaction.description;
  
  transactions.splice(index, 1);
  updateTransactionsTable();
  saveToLocalStorage();
}

function updateLedger() {
  const tbody = document.querySelector('#ledgerTable tbody');
  tbody.innerHTML = '';
  
  transactions.forEach(t => {
    // Get account types
    let debitType = '';
    let creditType = '';
    
    // Determine account types
    for (const [type, accountList] of Object.entries(accounts)) {
      if (accountList.includes(t.debitAccount)) debitType = type;
      if (accountList.includes(t.creditAccount)) creditType = type;
    }

    // Entrada debe
    const debitRow = tbody.insertRow();
      debitRow.innerHTML = `
        <td>${t.date} - ${debitType}</td>
        <td>${t.description}</td>
        <td>${t.debitAccount}</td>
        <td>$${formatMoney(t.amount)}</td>
        <td></td>
      `;

    // Entrada haber
    const creditRow = tbody.insertRow();
      creditRow.innerHTML = `
        <td>${t.date} - ${creditType}</td>
        <td>${t.description}</td>
        <td>${t.creditAccount}</td>
        <td></td>
        <td>$${formatMoney(t.amount)}</td>
      `;
  });
}

function updateMajorBook() {
  const accountLedgers = {};
  
  // Initialize account ledgers only for accounts that exist in the catalog
  Object.values(accounts).flat().forEach(account => {
    if (account) { // Check if account exists
      accountLedgers[account] = {
        transactions: [],
        balance: 0
      };
    }
  });
  
  // Group transactions by account
  transactions.forEach(t => {
    if (!accountLedgers[t.debitAccount]) return; // Skip if account doesn't exist
    if (!accountLedgers[t.creditAccount]) return; // Skip if account doesn't exist
    
    // Add debit entry
    accountLedgers[t.debitAccount].transactions.push({
      date: t.date,
      description: t.description,
      debit: t.amount,
      credit: 0
    });
    accountLedgers[t.debitAccount].balance += t.amount;
    
    // Add credit entry
    accountLedgers[t.creditAccount].transactions.push({
      date: t.date,
      description: t.description,  
      debit: 0,
      credit: t.amount
    });
    accountLedgers[t.creditAccount].balance -= t.amount;
  });
  
  // Generate HTML for each account
  const majorBookContent = document.getElementById('majorBookContent');
  majorBookContent.innerHTML = '';
  
  Object.entries(accountLedgers).forEach(([account, data]) => {
    if (!account || !data || data.transactions.length === 0) return; // Skip invalid or empty accounts
    
    const accountDiv = document.createElement('div');
    accountDiv.innerHTML = `
      <h3 style="margin-top: 20px; margin-bottom: 10px;">${account}</h3>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripci√≥n</th>
            <th>Debe</th>
            <th>Haber</th>
            <th>Saldo</th>
          </tr>
        </thead>
        <tbody>
          ${data.transactions.map(t => `
            <tr>
              <td>${t.date}</td>
              <td>${t.description}</td>
              <td>${t.debit ? '$' + formatMoney(t.debit) : ''}</td>
              <td>${t.credit ? '$' + formatMoney(t.credit) : ''}</td>
              <td>$${formatMoney(Math.abs(data.balance))}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    majorBookContent.appendChild(accountDiv);
  });
}

function updateBalance() {
  const balances = {};
  
  // Calculate balances
  transactions.forEach(t => {
    if (!balances[t.debitAccount]) balances[t.debitAccount] = 0;
    if (!balances[t.creditAccount]) balances[t.creditAccount] = 0;
    
    balances[t.debitAccount] += t.amount;
    balances[t.creditAccount] -= t.amount;
  });
  
  const tbody = document.querySelector('#balanceTable tbody');
  tbody.innerHTML = '';
  
  let totalActivos = 0;
  let totalPasivos = 0;
  let totalCapital = 0;
  
  // Create balance sheet row
  const balanceRow = tbody.insertRow();
  const activosCell = balanceRow.insertCell();
  const pasivoCapitalCell = balanceRow.insertCell();
  
  let activosHTML = '<h3 style="color: #34495e; font-weight: 800; border-bottom: 2px solid #34495e; padding-bottom: 5px; margin-bottom: 15px;">Activos</h3>';
  let pasivosHTML = '<h3 style="color: #34495e; font-weight: 800; border-bottom: 2px solid #34495e; padding-bottom: 5px; margin-bottom: 15px;">Pasivos</h3>';
  let capitalHTML = '<h3 style="color: #34495e; font-weight: 800; border-bottom: 2px solid #34495e; padding-bottom: 5px; margin: 25px 0 15px 0;">Capital</h3>';
  
  // Process accounts by type
  Object.entries(balances).forEach(([account, balance]) => {
    if (balance === 0) return; // Skip accounts with zero balance
    
    const formattedAmount = `<span style="float: right;">$${formatMoney(Math.abs(balance))}</span>`;
    
    if (accounts.activo.includes(account)) {
      activosHTML += `<p style="margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #eee;">${account}${formattedAmount}</p>`;
      totalActivos += balance;
    }
    if (accounts.pasivo.includes(account)) {
      pasivosHTML += `<p style="margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #eee;">${account}${formattedAmount}</p>`;
      totalPasivos += Math.abs(balance);
    }
    if (accounts.capital.includes(account)) {
      capitalHTML += `<p style="margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #eee;">${account}${formattedAmount}</p>`;
      totalCapital += Math.abs(balance);
    }
    if (accounts.resultados.includes(account)) {
      let isPositive = account.includes('Ventas');
      if (isPositive) {
        totalCapital += Math.abs(balance);
      } else {
        totalCapital -= Math.abs(balance);
      }
      capitalHTML += `<p style="margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #eee;">${account}${formattedAmount}</p>`;
    }
  });
  
  activosHTML += `<h4 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #34495e; color: #2c3e50; font-weight: 700;">Total Activos: <span style="float: right;">$${formatMoney(Math.abs(totalActivos))}</span></h4>`;
  pasivosHTML += `<h4 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #34495e; color: #2c3e50; font-weight: 700;">Total Pasivos: <span style="float: right;">$${formatMoney(Math.abs(totalPasivos))}</span></h4>`;
  capitalHTML += `<h4 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #34495e; color: #2c3e50; font-weight: 700;">Total Capital: <span style="float: right;">$${formatMoney(Math.abs(totalCapital))}</span></h4>`;
  
  activosCell.innerHTML = `<div style="padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${activosHTML}</div>`;
  pasivoCapitalCell.innerHTML = `<div style="padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${pasivosHTML}${capitalHTML}</div>`;
  
  // Add total pasivo + capital
  pasivoCapitalCell.innerHTML += `<h4 style="margin-top: 20px; padding: 15px; background: #34495e; color: white; border-radius: 8px; text-align: right;">Total Pasivo + Capital: $${formatMoney(Math.abs(totalPasivos) + Math.abs(totalCapital))}</h4>`;
}

function saveToLocalStorage() {
  localStorage.setItem('accountingTransactions', JSON.stringify(transactions));
  localStorage.setItem('accountingProducts', JSON.stringify(products));
}

// Company info persistence
function saveCompanyToLocalStorage(company) {
  localStorage.setItem('accountingCompany', JSON.stringify(company));
}

function loadCompanyFromLocalStorage() {
  const saved = localStorage.getItem('accountingCompany');
  if (!saved) return null;
  try {
    return JSON.parse(saved);
  } catch (e) {
    return null;
  }
}

// Company modal controls
function openCompanyModal() {
  const c = loadCompanyFromLocalStorage();
  if (c) {
    document.getElementById('companyName').value = c.name || '';
    document.getElementById('companyResponsible').value = c.responsible || '';
    document.getElementById('companyEmail').value = c.email || '';
    document.getElementById('companyActivity').value = c.activity || '';
    document.getElementById('companyPhone').value = c.phone || '';
    document.getElementById('companyRegistry').value = c.registry || '';
    document.getElementById('companyNIT').value = c.nit || '';
  } else {
    document.getElementById('companyName').value = '';
    document.getElementById('companyResponsible').value = '';
    document.getElementById('companyEmail').value = '';
    document.getElementById('companyActivity').value = '';
    document.getElementById('companyPhone').value = '';
    document.getElementById('companyRegistry').value = '';
    document.getElementById('companyNIT').value = '';
  }
  document.getElementById('companyNameMsg').textContent = '';
  document.getElementById('companyRespMsg').textContent = '';
  document.getElementById('companyEmailMsg').textContent = '';
  document.getElementById('companyBackdrop').style.display = 'block';
  document.getElementById('companyModal').style.display = 'block';
}

function closeCompanyModal() {
  document.getElementById('companyBackdrop').style.display = 'none';
  document.getElementById('companyModal').style.display = 'none';
}

function validateCompanyInputs(name, responsible, email) {
  let ok = true;
  document.getElementById('companyNameMsg').textContent = '';
  document.getElementById('companyRespMsg').textContent = '';
  document.getElementById('companyEmailMsg').textContent = '';

  if (!name || !name.trim()) {
    document.getElementById('companyNameMsg').textContent = 'Nombre de la empresa es obligatorio.';
    ok = false;
  }
  if (!responsible || !responsible.trim()) {
    document.getElementById('companyRespMsg').textContent = 'Responsable es obligatorio.';
    ok = false;
  }
  if (!email || !email.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    document.getElementById('companyEmailMsg').textContent = 'Correo v√°lido es obligatorio.';
    ok = false;
  }
  return ok;
}

function saveCompany() {
  const name = document.getElementById('companyName').value;
  const responsible = document.getElementById('companyResponsible').value;
  const email = document.getElementById('companyEmail').value;
  const activity = document.getElementById('companyActivity').value;
  const phone = document.getElementById('companyPhone').value;
  const registry = document.getElementById('companyRegistry').value;
  const nit = document.getElementById('companyNIT').value;

  if (!validateCompanyInputs(name, responsible, email)) return;

  const company = {
    name: name.trim(),
    responsible: responsible.trim(),
    email: email.trim(),
    activity: activity.trim(),
    phone: phone.trim(),
    registry: registry.trim(),
    nit: nit.trim()
  };

  saveCompanyToLocalStorage(company);
  renderCompanyInfo();
  closeCompanyModal();
  showNotification('Informaci√≥n de la empresa guardada');
}

function renderCompanyInfo() {
  const container = document.getElementById('companyInfo');
  const c = loadCompanyFromLocalStorage();
  if (!container) return;
  if (!c) {
    container.innerHTML = '<em style="color:#888;">No hay informaci√≥n de empresa guardada.</em>';
    return;
  }
  container.innerHTML = `
    <strong>${c.name}</strong>
    <div style="color:#666; margin-top:6px;">
      <div><strong>Responsable:</strong> ${c.responsible}</div>
      <div><strong>Correo:</strong> ${c.email}</div>
      ${c.phone ? `<div><strong>Tel√©fono:</strong> ${c.phone}</div>` : ''}
      ${c.activity ? `<div><strong>Giro:</strong> ${c.activity}</div>` : ''}
      ${c.registry ? `<div><strong>Registro:</strong> ${c.registry}</div>` : ''}
      ${c.nit ? `<div><strong>NIT:</strong> ${c.nit}</div>` : ''}
    </div>
  `;
}

// render company info on load
document.addEventListener('DOMContentLoaded', () => {
  renderCompanyInfo();
});

function loadFromLocalStorage() {
  const saved = localStorage.getItem('accountingTransactions');
  const savedProducts = localStorage.getItem('accountingProducts');
  if (saved) {
    transactions = JSON.parse(saved);
    updateTransactionsTable();
  }
  if (savedProducts) {
    try {
      const parsed = JSON.parse(savedProducts);
      if (Array.isArray(parsed)) {
        // Merge saved products keeping any new defaults
        parsed.forEach(sp => {
          const existing = products.find(p => p.id === sp.id);
          if (existing) {
            existing.stock = sp.stock || existing.stock || 0;
            existing.price = sp.price !== undefined ? sp.price : existing.price;
          } else {
            products.push(sp);
          }
        });
      }
    } catch (e) {
      console.warn('Error cargando productos guardados', e);
    }
    populateProducts();
  } else {
    populateProducts();
  }
}

function saveData() {
  saveToLocalStorage();
  showNotification('Datos guardados exitosamente');
}

function exportToJSON() {
  const dataStr = JSON.stringify(transactions, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = 'transactions.json';
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
}

function importJSON() {
  document.getElementById('jsonInput').click();
}

document.getElementById('jsonInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      transactions = JSON.parse(e.target.result);
      updateTransactionsTable();
      saveToLocalStorage();
      showNotification('Datos importados exitosamente');
    } catch (error) {
      showNotification('Error al importar el archivo JSON');
    }
  };
  
  reader.readAsText(file);
});

function exportToExcel() {
  // Create workbook
  const wb = XLSX.utils.book_new();
  
  // Generate Libro Diario data
  const diarioData = [['Fecha', 'Descripci√≥n', 'Cuenta', 'Debe', 'Haber']];
  transactions.forEach(t => {
    diarioData.push([
      t.date,
      t.description,
      t.debitAccount,
      t.amount.toFixed(2),
      ''
    ]);
    diarioData.push([
      t.date,
      t.description,
      t.creditAccount,
      '',
      t.amount.toFixed(2)
    ]);
  });
  
  // Generate Libro Mayor data
  const accountLedgers = {};
  Object.values(accounts).flat().forEach(account => {
    if (account) {
      accountLedgers[account] = {
        transactions: [],
        balance: 0
      };
    }
  });

  transactions.forEach(t => {
    if (accountLedgers[t.debitAccount]) {
      accountLedgers[t.debitAccount].transactions.push({
        date: t.date,
        description: t.description,
        debit: t.amount,
        credit: 0
      });
      accountLedgers[t.debitAccount].balance += t.amount;
    }
    
    if (accountLedgers[t.creditAccount]) {
      accountLedgers[t.creditAccount].transactions.push({
        date: t.date,
        description: t.description,
        debit: 0,
        credit: t.amount
      });
      accountLedgers[t.creditAccount].balance -= t.amount;
    }
  });

  const mayorData = [['Cuenta', 'Fecha', 'Descripci√≥n', 'Debe', 'Haber', 'Saldo']];
  Object.entries(accountLedgers).forEach(([account, data]) => {
    if (data.transactions.length > 0) {
      data.transactions.forEach(t => {
        mayorData.push([
          account,
          t.date,
          t.description,
          t.debit ? t.debit.toFixed(2) : '',
          t.credit ? t.credit.toFixed(2) : '',
          Math.abs(data.balance).toFixed(2)
        ]);
      });
    }
  });

  // Generate Balance General data
  const balances = {};
  transactions.forEach(t => {
    if (!balances[t.debitAccount]) balances[t.debitAccount] = 0;
    if (!balances[t.creditAccount]) balances[t.creditAccount] = 0;
    
    balances[t.debitAccount] += t.amount;
    balances[t.creditAccount] -= t.amount;
  });

  let totalActivos = 0;
  let totalPasivos = 0;
  let totalCapital = 0;

  const balanceData = [['Tipo', 'Cuenta', 'Monto']];

  Object.entries(balances).forEach(([account, balance]) => {
    if (balance === 0) return;

    if (accounts.activo.includes(account)) {
      balanceData.push(['Activo', account, Math.abs(balance).toFixed(2)]);
      totalActivos += balance;
    }
    if (accounts.pasivo.includes(account)) {
      balanceData.push(['Pasivo', account, Math.abs(balance).toFixed(2)]);
      totalPasivos += Math.abs(balance);
    }
    if (accounts.capital.includes(account)) {
      balanceData.push(['Capital', account, Math.abs(balance).toFixed(2)]);
      totalCapital += Math.abs(balance);
    }
    if (accounts.resultados.includes(account)) {
      balanceData.push(['Capital', account, Math.abs(balance).toFixed(2)]);
      if (account.includes('Ventas')) {
        totalCapital += Math.abs(balance);
      } else {
        totalCapital -= Math.abs(balance);
      }
    }
  });

  balanceData.push(['Totales', 'Total Activos', Math.abs(totalActivos).toFixed(2)]);
  balanceData.push(['Totales', 'Total Pasivos', Math.abs(totalPasivos).toFixed(2)]);
  balanceData.push(['Totales', 'Total Capital', Math.abs(totalCapital).toFixed(2)]);
  balanceData.push(['Totales', 'Total Pasivo + Capital', (Math.abs(totalPasivos) + Math.abs(totalCapital)).toFixed(2)]);

  // Create worksheets
  const wsDiario = XLSX.utils.aoa_to_sheet(diarioData);
  const wsMayor = XLSX.utils.aoa_to_sheet(mayorData);
  const wsBalance = XLSX.utils.aoa_to_sheet(balanceData);

  // Add worksheets to workbook
  XLSX.utils.book_append_sheet(wb, wsDiario, "Libro Diario");
  XLSX.utils.book_append_sheet(wb, wsMayor, "Libro Mayor");
  XLSX.utils.book_append_sheet(wb, wsBalance, "Balance General");

  // Save workbook
  XLSX.writeFile(wb, "sistema_contable.xlsx");
  showNotification('Archivo Excel generado exitosamente');
}

function showHelp() {
  document.getElementById('helpModal').style.display = 'block';
  document.getElementById('modalBackdrop').style.display = 'block';
}

function hideHelp() {
  document.getElementById('helpModal').style.display = 'none';
  document.getElementById('modalBackdrop').style.display = 'none';
}

let _notificationTimeout = null;
function showNotification(message, durationMs = 3500) {
  // Clear any pending hide timeout so notifications remain visible for full duration
  if (_notificationTimeout) {
    clearTimeout(_notificationTimeout);
    _notificationTimeout = null;
  }

  const modal = document.getElementById('notificationModal');
  const backdrop = document.getElementById('notificationBackdrop');
  if (!modal || !backdrop) return;

  // Ensure notification is on top visually
  modal.style.zIndex = 2401;
  backdrop.style.zIndex = 2400;

  document.getElementById('notificationContent').textContent = message;
  modal.style.display = 'block';
  backdrop.style.display = 'block';

  // Auto-hide after specified duration (defaults ~3.5s)
  _notificationTimeout = setTimeout(() => {
    hideNotification();
    _notificationTimeout = null;
  }, durationMs);
}

function hideNotification() {
  const modal = document.getElementById('notificationModal');
  const backdrop = document.getElementById('notificationBackdrop');
  if (modal) modal.style.display = 'none';
  if (backdrop) backdrop.style.display = 'none';
  if (_notificationTimeout) {
    clearTimeout(_notificationTimeout);
    _notificationTimeout = null;
  }
}

let transactionToDelete = null;

function showDeleteConfirmation(index) {
  transactionToDelete = index;
  document.getElementById('confirmationModal').style.display = 'block';
  document.getElementById('confirmationBackdrop').style.display = 'block';
}

function confirmDelete() {
  if (transactionToDelete !== null) {
    transactions.splice(transactionToDelete, 1);
    updateTransactionsTable();
    saveToLocalStorage();
    hideDeleteConfirmation();
    showNotification('Transacci√≥n eliminada exitosamente');
  }
}

function cancelDelete() {
  hideDeleteConfirmation();
}

function hideDeleteConfirmation() {
  document.getElementById('confirmationModal').style.display = 'none';
  document.getElementById('confirmationBackdrop').style.display = 'none';
  transactionToDelete = null;
}

function addExampleTransactions() {
  const today = new Date().toISOString().split('T')[0];
  
  const exampleTransactions = [
    {
      date: today,
      type: 'venta',
      debitAccount: '1.1.1.1 - Caja General',
      creditAccount: '4.5.1.1 - Ventas Nacionales',
      amount: 5000,
      description: 'Venta de mercanc√≠a en efectivo',
      debitCode: '1.1.1.1',
      creditCode: '4.5.1.1'
    },
    {
      date: today,
      type: 'compra',
      debitAccount: '1.2.3.2 - Equipo de C√≥mputo',
      creditAccount: '2.3.1.1 - Proveedores Nacionales',
      amount: 15000,
      description: 'Compra de equipo de c√≥mputo a cr√©dito',
      debitCode: '1.2.3.2',
      creditCode: '2.3.1.1'
    },
    {
      date: today,
      type: 'gasto',
      debitAccount: '6.7.2.4 - Luz, Agua y Tel√©fono',
      creditAccount: '1.1.2.1 - Bancos Nacionales',
      amount: 2500,
      description: 'Pago de servicio de luz mensual',
      debitCode: '6.7.2.4',
      creditCode: '1.1.2.1'
    },
    {
      date: today,
      type: 'pago',
      debitAccount: '2.3.1.1 - Proveedores Nacionales',
      creditAccount: '1.1.2.1 - Bancos Nacionales',
      amount: 8000,
      description: 'Pago a proveedor por mercanc√≠a',
      debitCode: '2.3.1.1',
      creditCode: '1.1.2.1'
    },
    {
      date: today,
      type: 'credito',
      debitAccount: '1.1.3.1 - Clientes Nacionales',
      creditAccount: '4.5.1.1 - Ventas Nacionales',
      amount: 12000,
      description: 'Venta a cr√©dito a cliente',
      debitCode: '1.1.3.1',
      creditCode: '4.5.1.1'
    },
    {
      date: today,
      type: 'inversion',
      debitAccount: '1.1.2.1 - Bancos Nacionales',
      creditAccount: '3.4.1.0 - Capital Social',
      amount: 50000,
      description: 'Inversi√≥n de accionistas',
      debitCode: '1.1.2.1',
      creditCode: '3.4.1.0'
    },
    {
      date: today,
      type: 'financiamiento',
      debitAccount: '1.1.2.1 - Bancos Nacionales',
      creditAccount: '2.3.2.0 - Documentos por Pagar',
      amount: 100000,
      description: 'Pr√©stamo bancario recibido',
      debitCode: '1.1.2.1',
      creditCode: '2.3.2.0'
    }
  ];

  transactions.push(...exampleTransactions);
  updateTransactionsTable();
  saveToLocalStorage();
  showNotification('Se agregaron 7 transacciones de ejemplo');
}

function clearExampleTransactions() {
  document.getElementById('clearConfirmationModal').style.display = 'block';
  document.getElementById('clearConfirmationBackdrop').style.display = 'block';
}

function confirmClear() {
  transactions = [];
  updateTransactionsTable();
  saveToLocalStorage();
  hideClearConfirmation();
  showNotification('Se han eliminado todas las transacciones');
}

function cancelClear() {
  hideClearConfirmation();
}

function hideClearConfirmation() {
  document.getElementById('clearConfirmationModal').style.display = 'none';
  document.getElementById('clearConfirmationBackdrop').style.display = 'none';
}

function generateLedgerPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(16);
  doc.text('Libro Diario', 14, 15);
  
  const tableData = [];
  transactions.forEach(t => {
    tableData.push([
      t.date,
      t.description,
      t.debitAccount,
      `$${formatMoney(t.amount)}`,
      ''
    ]);
    tableData.push([
      t.date,
      t.description,
      t.creditAccount,
      '',
      `$${formatMoney(t.amount)}`
    ]);
  });

  doc.autoTable({
    startY: 25,
    head: [['Fecha', 'Descripci√≥n', 'Cuenta', 'Debe', 'Haber']],
    body: tableData,
    theme: 'grid',
    styles: { fontSize: 8 }
  });

  doc.save('libro_diario.pdf');
  showNotification('PDF del Libro Diario generado exitosamente');
}

function generateMajorBookPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(16);
  doc.text('Libro Mayor', 14, 15);
  
  let yPosition = 25;
  
  const accountLedgers = {};
  Object.values(accounts).flat().forEach(account => {
    if (account) {
      accountLedgers[account] = {
        transactions: [],
        balance: 0
      };
    }
  });

  transactions.forEach(t => {
    if (accountLedgers[t.debitAccount]) {
      accountLedgers[t.debitAccount].transactions.push({
        date: t.date,
        description: t.description,
        debit: t.amount,
        credit: 0
      });
      accountLedgers[t.debitAccount].balance += t.amount;
    }
    
    if (accountLedgers[t.creditAccount]) {
      accountLedgers[t.creditAccount].transactions.push({
        date: t.date,
        description: t.description,
        debit: 0,
        credit: t.amount
      });
      accountLedgers[t.creditAccount].balance -= t.amount;
    }
  });

  Object.entries(accountLedgers).forEach(([account, data]) => {
    if (data.transactions.length > 0) {
      if (yPosition > 250) {
        doc.addPage();
        yPosition = 25;
      }

      doc.setFontSize(12);
      doc.text(account, 14, yPosition);
      
      const tableData = data.transactions.map(t => [
        t.date,
        t.description,
        t.debit ? `$${formatMoney(t.debit)}` : '',
        t.credit ? `$${formatMoney(t.credit)}` : '',
        `$${formatMoney(Math.abs(data.balance))}`
      ]);

      doc.autoTable({
        startY: yPosition + 5,
        head: [['Fecha', 'Descripci√≥n', 'Debe', 'Haber', 'Saldo']],
        body: tableData,
        theme: 'grid',
        styles: { fontSize: 8 }
      });

      yPosition = doc.lastAutoTable.finalY + 20;
    }
  });

  doc.save('libro_mayor.pdf');
  showNotification('PDF del Libro Mayor generado exitosamente');
}

function generateBalancePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(16);
  doc.text('Balance General', 14, 15);

  const balances = {};
  transactions.forEach(t => {
    if (!balances[t.debitAccount]) balances[t.debitAccount] = 0;
    if (!balances[t.creditAccount]) balances[t.creditAccount] = 0;
    
    balances[t.debitAccount] += t.amount;
    balances[t.creditAccount] -= t.amount;
  });

  let totalActivos = 0;
  let totalPasivos = 0;
  let totalCapital = 0;

  const activosData = [];
  const pasivosData = [];
  const capitalData = [];

  Object.entries(balances).forEach(([account, balance]) => {
    if (balance === 0) return;

    if (accounts.activo.includes(account)) {
      activosData.push([account, `$${formatMoney(Math.abs(balance))}`]);
      totalActivos += balance;
    }
    if (accounts.pasivo.includes(account)) {
      pasivosData.push([account, `$${formatMoney(Math.abs(balance))}`]);
      totalPasivos += Math.abs(balance);
    }
    if (accounts.capital.includes(account)) {
      capitalData.push([account, `$${formatMoney(Math.abs(balance))}`]);
      totalCapital += Math.abs(balance);
    }
    if (accounts.resultados.includes(account)) {
      capitalData.push([account, `$${formatMoney(Math.abs(balance))}`]);
      if (account.includes('Ventas')) {
        totalCapital += Math.abs(balance);
      } else {
        totalCapital -= Math.abs(balance);
      }
    }
  });

  activosData.push(['Total Activos', `$${formatMoney(Math.abs(totalActivos))}`]);
  pasivosData.push(['Total Pasivos', `$${formatMoney(Math.abs(totalPasivos))}`]);
  capitalData.push(['Total Capital', `$${formatMoney(Math.abs(totalCapital))}`]);
  
  doc.setFontSize(14);
  doc.text('Activos', 14, 30);
  doc.autoTable({
    startY: 35,
    head: [['Cuenta', 'Monto']],
    body: activosData,
    theme: 'grid',
    styles: { fontSize: 8 }
  });

  doc.text('Pasivos', 14, doc.lastAutoTable.finalY + 15);
  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 20,
    head: [['Cuenta', 'Monto']],
    body: pasivosData,
    theme: 'grid',
    styles: { fontSize: 8 }
  });

  doc.text('Capital', 14, doc.lastAutoTable.finalY + 15);
  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 20,
    head: [['Cuenta', 'Monto']],
    body: capitalData,
    theme: 'grid',
    styles: { fontSize: 8 }
  });

  doc.setFontSize(12);
  doc.text(`Total Pasivo + Capital: $${formatMoney(Math.abs(totalPasivos) + Math.abs(totalCapital))}`, 14, doc.lastAutoTable.finalY + 15);

  doc.save('balance_general.pdf');
  showNotification('PDF del Balance General generado exitosamente');
}
</script>

<!-- Security & performance module that patches storage, notification and sanitization -->
<script type="module" src="./modules/app_security.js"></script>

</body>
</html>